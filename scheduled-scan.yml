name: Scanner de Cl√©s API IA - Analyse Planifi√©e

# Options multiples de d√©clenchement planifi√©
on:
  schedule:
    
    - cron: '0 23 * * *'
    
    # Autres horaires possibles, d√©commentez pour activer :
    # - cron: '0 */6 * * *'    # Toutes les 6 heures
    # - cron: '0 0,12 * * *'   # Quotidien √† 00:00 et 12:00
    # - cron: '0 2 * * 1'      # Lundi √† 02:00
    # - cron: '0 2 1 * *'      # 1er du mois √† 02:00
  
  # D√©clenchement manuel √©galement support√©
  workflow_dispatch:

# Contr√¥le de concurrence - une seule t√¢che d'analyse √† la fois
concurrency:
  group: analyse-planifiee
  cancel-in-progress: false

# Configuration des autorisations
permissions:
  contents: write  # Permet de soumettre du code
  issues: write    # Permet de cr√©er et mettre √† jour les Issues

jobs:
  analyse-planifiee:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # D√©lai d'expiration de 60 minutes
    
    steps:
      - name: üìÖ Affichage de l'heure d'ex√©cution
        run: |
          echo "üïê Heure actuelle (UTC) : $(date -u)"
          
      
      - name: üì• R√©cup√©ration du code
        uses: actions/checkout@v4
      
      - name: üêç Configuration de Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: üì¶ Installation des d√©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ‚öôÔ∏è Configuration de l'environnement
        env:
          GITHUB_SCAN_TOKEN: ${{ secrets.GH_SCAN_TOKEN }}
        run: |
          echo "GITHUB_TOKEN=${GITHUB_SCAN_TOKEN}" > .env
          echo "OUTPUT_DIR=./rapports_analyse" >> .env
          mkdir -p rapports_analyse
      
      - name: üîç Ex√©cution de l'analyse planifi√©e
        id: analyse
        run: |
          echo "D√©marrage de la t√¢che d'analyse automatique..."
          python scan_github.py --auto --max-repos 200 2>&1 | tee journal_analyse.log
          
          # Enregistrement du statut de l'analyse
          if [ $? -eq 0 ]; then
            echo "statut_analyse=succes" >> $GITHUB_OUTPUT
          else
            echo "statut_analyse=echec" >> $GITHUB_OUTPUT
          fi
      
      - name: üìä Analyse des r√©sultats
        id: analyser
        if: always()
        run: |
          # V√©rification de la g√©n√©ration de rapports
          if [ -d "rapports_analyse" ] && [ "$(ls -A rapports_analyse)" ]; then
            FICHIER_RAPPORT=$(ls -t rapports_analyse/*.txt | head -1)
            
            # Extraction du nombre de probl√®mes d√©tect√©s
            TOTAL=$(grep "Nombre total de probl√®mes d√©tect√©s:" "$FICHIER_RAPPORT" | grep -oE '[0-9]+' || echo "0")
            ELEVE=$(grep "Confiance √©lev√©e:" "$FICHIER_RAPPORT" | grep -oE '[0-9]+' || echo "0")
            MOYEN=$(grep "Confiance moyenne:" "$FICHIER_RAPPORT" | grep -oE '[0-9]+' || echo "0")
            
            echo "problemes_totaux=$TOTAL" >> $GITHUB_OUTPUT
            echo "confiance_elevee=$ELEVE" >> $GITHUB_OUTPUT
            echo "confiance_moyenne=$MOYEN" >> $GITHUB_OUTPUT
            
            echo "üìä Statistiques de l'analyse :"
            echo "  - Total des probl√®mes : $TOTAL"
            echo "  - Confiance √©lev√©e : $ELEVE"
            echo "  - Confiance moyenne : $MOYEN"
            
            # D√©termination de la n√©cessit√© d'une alerte
            if [ "$TOTAL" -gt 0 ]; then
              echo "alerte_necessaire=true" >> $GITHUB_OUTPUT
            else
              echo "alerte_necessaire=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ö†Ô∏è Aucun rapport d'analyse trouv√©"
            echo "problemes_totaux=0" >> $GITHUB_OUTPUT
            echo "alerte_necessaire=false" >> $GITHUB_OUTPUT
          fi
      
      - name: üìù G√©n√©ration du r√©sum√©
        if: always()
        run: |
          echo "# üîç Rapport d'analyse planifi√©e" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Heure d'ex√©cution** : $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Mode d'analyse** : Recherche automatique de projets IA" >> $GITHUB_STEP_SUMMARY
          echo "**Statut de l'analyse** : ${{ steps.analyse.outputs.statut_analyse }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # V√©rification de l'existence de fichiers txt
          if ls rapports_analyse/*.txt 1> /dev/null 2>&1; then
            echo "## üìä Statistiques de l'analyse" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- üî¥ Probl√®mes de confiance √©lev√©e : ${{ steps.analyser.outputs.confiance_elevee }}" >> $GITHUB_STEP_SUMMARY
            echo "- üü° Probl√®mes de confiance moyenne : ${{ steps.analyser.outputs.confiance_moyenne }}" >> $GITHUB_STEP_SUMMARY
            echo "- üì¶ Total des probl√®mes : ${{ steps.analyser.outputs.problemes_totaux }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "## üìÑ Aper√ßu du rapport" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -n 100 rapports_analyse/*.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: üì§ T√©l√©versement du rapport
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analyse-planifiee-${{ github.run_number }}
          path: |
            rapports_analyse/
            journal_analyse.log
          retention-days: 90
          if-no-files-found: ignore
      
      - name: üíæ Soumission de l'historique et des rapports d'analyse
        if: always()
        run: |
          git config user.name "Bsh54"
          git config user.email "shadrakbsh@gmail.com"
          
          # Ajout de l'historique d'analyse
          git add historique_analyse/
          
          # Ajout des rapports d'analyse
          if [ -d "rapports_analyse" ] && [ "$(ls -A rapports_analyse 2>/dev/null)" ]; then
            git add rapports_analyse/
            echo "‚úÖ Rapports d'analyse d√©tect√©s, seront soumis ensemble"
          fi
          
          # V√©rification des modifications
          if git diff --cached --quiet; then
            echo "Aucun nouvel historique ou rapport d'analyse"
          else
            # Statistiques
            HISTORIQUE_MODIFIE=$(git diff --cached --name-only | grep "historique_analyse/" | wc -l | tr -d ' ')
            RAPPORTS_MODIFIES=$(git diff --cached --name-only | grep "rapports_analyse/" | wc -l | tr -d ' ')
            
            # Message de commit
            MSG_COMMIT="üìù Mise √† jour des donn√©es d'analyse [skip ci]"
            if [ "$HISTORIQUE_MODIFIE" -gt 0 ] && [ "$RAPPORTS_MODIFIES" -gt 0 ]; then
              MSG_COMMIT="üìù Mise √† jour de l'historique et des rapports d'analyse [skip ci]"
            elif [ "$RAPPORTS_MODIFIES" -gt 0 ]; then
              MSG_COMMIT="üìÑ Ajout de rapports d'analyse [skip ci]"
            fi
            
            git commit -m "$MSG_COMMIT"
            
            # Synchronisation des modifications distantes pour √©viter les conflits
            git pull --rebase origin main || {
              echo "‚ö†Ô∏è Conflit de rebase, tentative avec la version locale"
              git rebase --abort
              git pull --rebase --strategy-option=ours origin main
            }
            
            git push
            echo "‚úÖ Soumis : $HISTORIQUE_MODIFIE fichier(s) d'historique, $RAPPORTS_MODIFIES fichier(s) de rapport"
          fi
      
      - name: üö® Cr√©ation d'Issue d'alerte (si probl√®mes d√©tect√©s)
        if: steps.analyser.outputs.alerte_necessaire == 'true'
        uses: actions/github-script@v7
        env:
          PROBLEMES_TOTAL: ${{ steps.analyser.outputs.problemes_totaux }}
          CONFIANCE_ELEVEE: ${{ steps.analyser.outputs.confiance_elevee }}
          CONFIANCE_MOYENNE: ${{ steps.analyser.outputs.confiance_moyenne }}
        with:
          script: |
            const fs = require('fs');
            const fichiersRapport = fs.readdirSync('rapports_analyse');
            
            if (fichiersRapport.length > 0) {
              const cheminRapport = `rapports_analyse/${fichiersRapport[0]}`;
              const contenu = fs.readFileSync(cheminRapport, 'utf8');
              const apercu = contenu.split('\n').slice(0, 150).join('\n');
              
              const total = process.env.PROBLEMES_TOTAL;
              const elevee = process.env.CONFIANCE_ELEVEE;
              const moyenne = process.env.CONFIANCE_MOYENNE;
              
              // V√©rification de l'existence d'une Issue du jour
              const aujourdhui = new Date().toISOString().split('T')[0];
              const issuesExistantes = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'analyse-auto,securite',
                state: 'open'
              });
              
              const issueDuJour = issuesExistantes.data.find(issue => 
                issue.title.includes(aujourdhui)
              );
              
              if (issueDuJour) {
                // Mise √† jour de l'Issue existante
                const corpsMiseAJour = [
                  '## üîÑ Mise √† jour : nouvelles d√©couvertes d\'analyse',
                  '',
                  `Heure de l'analyse : ${new Date().toLocaleString('fr-FR')}`,
                  `Ex√©cution : [#${context.runNumber}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                  '',
                  '### üìä Statistiques de cette analyse',
                  `- üî¥ Confiance √©lev√©e : ${elevee}`,
                  `- üü° Confiance moyenne : ${moyenne}`,
                  `- üì¶ Total : ${total}`,
                  '',
                  'Consultez les Artifacts pour le rapport complet.'
                ].join('\n');
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueDuJour.number,
                  body: corpsMiseAJour
                });
              } else {
                // Cr√©ation d'une nouvelle Issue
                const alerteElevee = elevee > 0 ? '‚ö†Ô∏è N√©cessite un traitement imm√©diat' : '';
                const alerteMoyenne = moyenne > 0 ? '‚ö†Ô∏è Recommand√© de v√©rifier' : '';
                
                const titreIssue = `üö® [${aujourdhui}] Analyse de s√©curit√© : ${total} fuite(s) potentielle(s) de cl√©s d√©tect√©e(s)`;
                const corpsIssue = [
                  '# üîç Alerte d\'analyse automatique',
                  '',
                  '## üìã Informations d\'analyse',
                  '',
                  `- Date d'analyse : ${aujourdhui}`,
                  `- Heure d'ex√©cution : ${new Date().toLocaleString('fr-FR')}`,
                  `- Workflow : [Ex√©cution #${context.runNumber}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                  '',
                  '## üìä Statistiques des probl√®mes d√©tect√©s',
                  '',
                  `- üî¥ Confiance √©lev√©e : ${elevee} ${alerteElevee}`,
                  `- üü° Confiance moyenne : ${moyenne} ${alerteMoyenne}`,
                  `- üì¶ Total : ${total}`,
                  '',
                  '## üìÑ Aper√ßu du rapport',
                  '',
                  '```',
                  apercu,
                  '```',
                  '',
                  '## üîó Rapport complet',
                  '',
                  `T√©l√©chargez le rapport complet depuis [Artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}).`,
                  '',
                  '## ‚ö†Ô∏è √âtapes de traitement recommand√©es',
                  '',
                  '1. Revue imm√©diate : v√©rifier toutes les d√©couvertes de confiance √©lev√©e',
                  '2. Rotation des cl√©s : pour toute cl√© confirm√©e comme compromise, rotation imm√©diate chez le fournisseur',
                  '3. Nettoyage de l\'historique : utiliser git-filter-repo ou BFG pour nettoyer l\'historique Git',
                  '4. Mesures pr√©ventives :',
                  '   - Utiliser des variables d\'environnement pour les informations sensibles',
                  '   - Mettre √† jour le fichier .gitignore',
                  '   - Configurer des hooks pre-commit',
                  '   - Activer GitHub Secret Scanning',
                  '',
                  '## üìÖ Prochaine analyse',
                  '',
                  'La prochaine analyse automatique s\'ex√©cutera demain √† la m√™me heure.',
                  '',
                  '---',
                  `*ü§ñ Cette Issue a √©t√© cr√©√©e automatiquement par GitHub Actions - [Voir le workflow](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/.github/workflows/analyse-planifiee.yml)*`
                ].join('\n');
                
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: titreIssue,
                  body: corpsIssue,
                  labels: ['securite', 'analyse-auto', 'a-reviser'],
                  assignees: []
                });
              }
            }
      
      - name: ‚úÖ Analyse termin√©e
        if: always()
        run: |
          if [ "${{ steps.analyser.outputs.problemes_totaux }}" -gt 0 ]; then
            echo "‚ö†Ô∏è Analyse termin√©e, ${{ steps.analyser.outputs.problemes_totaux }} probl√®me(s) potentiel(s) d√©tect√©(s)"
            echo "Consultez l'Issue g√©n√©r√©e et le rapport d√©taill√© dans Artifacts"
          else
            echo "‚úÖ Analyse termin√©e, aucun probl√®me apparent d√©tect√©"
          fi