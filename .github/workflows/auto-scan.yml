
name: Scanner de Cl√©s API IA - Analyse Automatique

# Conditions de d√©clenchement
on:

  schedule:
    - cron: '0 23 * * *'  # Ex√©cution quotidienne
    
  
  # D√©clenchement manuel
  workflow_dispatch:
    inputs:
      mode_analyse:
        description: 'Mode d analyse'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - utilisateur
          - organisation
      cible:
        description: 'Cible de l analyse (nom d utilisateur ou d organisation, peut √™tre vide en mode auto)'
        required: false
        type: string
      repos_max:
        description: 'Nombre maximum de d√©p√¥ts √† analyser'
        required: false
        default: '50'
        type: string

# Configuration des autorisations
permissions:
  contents: write  # Permet de soumettre du code
  issues: write    # Permet de cr√©er des Issues

# D√©finition des t√¢ches
jobs:
  analyse:
    runs-on: ubuntu-latest
    
    steps:
      # 1. R√©cup√©ration du code
      - name: üì• R√©cup√©ration du code
        uses: actions/checkout@v4
      
      # 2. Configuration de l environnement Python
      - name: üêç Configuration de Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      # 3. Installation des d√©pendances
      - name: üì¶ Installation des d√©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # 4. Cr√©ation du fichier de variables d environnement
      - name: ‚öôÔ∏è Configuration des variables d environnement
        run: |
          echo "GITHUB_TOKEN=${{ secrets.GH_SCAN_TOKEN }}" > .env
          echo "OUTPUT_DIR=./rapports_analyse" >> .env
      
      # 5. Ex√©cution de l analyse (t√¢che planifi√©e)
      - name: üîç Ex√©cution de l analyse automatique
        if: github.event_name == 'schedule'
        run: |
          python scan_github.py --auto --depots-max 50
      
      # 6. Ex√©cution de l analyse (d√©clenchement manuel - mode auto)
      - name: üîç Ex√©cution de l analyse (auto)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.mode_analyse == 'auto'
        run: |
          python scan_github.py --auto --depots-max ${{ github.event.inputs.repos_max }}
      
      # 7. Ex√©cution de l analyse (d√©clenchement manuel - mode utilisateur)
      - name: üîç Ex√©cution de l analyse (utilisateur)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.mode_analyse == 'utilisateur'
        run: |
          python scan_github.py --user ${{ github.event.inputs.cible }}
      
      # 8. Ex√©cution de l analyse (d√©clenchement manuel - mode organisation)
      - name: üîç Ex√©cution de l analyse (organisation)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.mode_analyse == 'organisation'
        run: |
          python scan_github.py --org ${{ github.event.inputs.cible }}
      
      # 9. T√©l√©versement du rapport d analyse
      - name: üì§ T√©l√©versement du rapport d analyse
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rapport-analyse-${{ github.run_number }}
          path: rapports_analyse/
          retention-days: 90
          if-no-files-found: ignore
      
      
      # 11. Optionnel : Envoi de notification (si des probl√®mes sont d√©tect√©s)
      - name: üîî V√©rification des probl√®mes d√©tect√©s
        id: verification_problemes
        run: |
          if grep -q "Nombre total de probl√®mes d√©tect√©s: [1-9]" rapports_analyse/*.txt 2>/dev/null; then
            echo "Probl√®mes d√©tect√©s"
            echo "problemes_detectes=true" >> $GITHUB_OUTPUT
          else
            echo "Aucun probl√®me d√©tect√©"
            echo "problemes_detectes=false" >> $GITHUB_OUTPUT
          fi
      
      # 12. Optionnel : Cr√©ation d Issue (si des probl√®mes critiques sont d√©tect√©s)
      - name: üì¢ Cr√©ation d Issue d alerte
        if: steps.verification_problemes.outputs.problemes_detectes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const fichiersRapport = fs.readdirSync('rapports_analyse');
            if (fichiersRapport.length > 0) {
              const contenuRapport = fs.readFileSync(`rapports_analyse/${fichiersRapport[0]}`, 'utf8');
              const lignes = contenuRapport.split('\n').slice(0, 100).join('\n');
              
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `‚ö†Ô∏è Analyse de s√©curit√© - Fuite potentielle de cl√©s d√©tect√©e - ${new Date().toISOString().split('T')[0]}`,
                body: `# üîç Rapport d analyse automatique\n\nCette analyse a d√©tect√© des fuites potentielles de cl√©s API.\n\n**Heure de l analyse**: ${new Date().toISOString()}\n**ID d ex√©cution**: #${context.runNumber}\n\n## üìÑ R√©sum√© du rapport\n\n\`\`\`\n${lignes}\n\`\`\`\n\nConsultez le rapport complet dans [Artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                labels: ['securit√©', 'analyse-auto']
              });
            }
