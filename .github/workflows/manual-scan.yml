name: Scanner de Cl√©s API IA - Analyse Manuelle

# D√©clenchement manuel uniquement
on:
  workflow_dispatch:
    inputs:
      type_analyse:
        description: 'Type d analyse'
        required: true
        type: choice
        options:
          - 'auto - Recherche automatique de projets IA'
          - 'utilisateur - Analyse d un utilisateur sp√©cifique'
          - 'organisation - Analyse d une organisation sp√©cifique'
          - 'depot - Analyse d un d√©p√¥t unique'
      
      cible:
        description: 'Cible d analyse (nom d utilisateur/organisation/d√©p√¥t complet, peut √™tre vide en mode auto)'
        required: false
        type: string
        default: ''
      
      repos_max:
        description: 'Nombre maximum de d√©p√¥ts √† analyser (valide uniquement en mode auto)'
        required: false
        type: number
        default: 50
      
      creer_issue:
        description: 'Cr√©er une Issue si des probl√®mes sont d√©tect√©s'
        required: false
        type: boolean
        default: true

# Configuration des autorisations
permissions:
  contents: write  # Permet de soumettre du code
  issues: write    # Permet de cr√©er des Issues

jobs:
  analyse-manuelle:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• R√©cup√©ration du code
        uses: actions/checkout@v4
      
      - name: üêç Configuration de Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: üì¶ Installation des d√©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ‚öôÔ∏è Configuration de l environnement
        run: |
          echo "GITHUB_TOKEN=${{ secrets.GH_SCAN_TOKEN }}" > .env
          echo "OUTPUT_DIR=./rapports_analyse" >> .env
          mkdir -p rapports_analyse
      
      - name: üîç Ex√©cution de l analyse - Mode Auto
        if: startsWith(github.event.inputs.type_analyse, 'auto')
        run: |
          echo "Ex√©cution de l analyse automatique, maximum ${{ github.event.inputs.repos_max }} d√©p√¥ts"
          python scan_github.py --auto --max-repos ${{ github.event.inputs.repos_max }}
      
      - name: üîç Ex√©cution de l analyse - Mode Utilisateur
        if: startsWith(github.event.inputs.type_analyse, 'utilisateur')
        run: |
          echo "Analyse de l utilisateur: ${{ github.event.inputs.cible }}"
          python scan_github.py --user "${{ github.event.inputs.cible }}"
      
      - name: üîç Ex√©cution de l analyse - Mode Organisation
        if: startsWith(github.event.inputs.type_analyse, 'organisation')
        run: |
          echo "Analyse de l organisation: ${{ github.event.inputs.cible }}"
          python scan_github.py --org "${{ github.event.inputs.cible }}"
      
      - name: üîç Ex√©cution de l analyse - Mode D√©p√¥t
        if: startsWith(github.event.inputs.type_analyse, 'depot')
        run: |
          echo "Analyse du d√©p√¥t: ${{ github.event.inputs.cible }}"
          python scan_github.py --repo "${{ github.event.inputs.cible }}"
      
      - name: üìä G√©n√©ration du r√©sum√© d analyse
        if: always()
        run: |
          echo "# üîç Analyse termin√©e" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Type d analyse**: ${{ github.event.inputs.type_analyse }}" >> $GITHUB_STEP_SUMMARY
          echo "**Cible d analyse**: ${{ github.event.inputs.cible }}" >> $GITHUB_STEP_SUMMARY
          echo "**Heure d ex√©cution**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f rapports_analyse/*.txt ]; then
            echo "## üìÑ R√©sultats d analyse" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -n 80 rapports_analyse/*.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: üì§ T√©l√©versement du rapport
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rapport-analyse-manuelle-${{ github.run_number }}
          path: rapports_analyse/
          retention-days: 90
          if-no-files-found: ignore
      
      - name: üíæ Soumission de l historique et des rapports d analyse
        if: always()
        run: |
          git config user.name "Bsh54"
          git config user.email "shadrakbsh@gmail.com"
          
          # Ajout de l historique d analyse
          git add historique_analyse/
          
          # Ajout des rapports d analyse
          if [ -d "rapports_analyse" ] && [ "$(ls -A rapports_analyse 2>/dev/null)" ]; then
            git add rapports_analyse/
            echo "‚úÖ Rapports d analyse d√©tect√©s, seront soumis ensemble"
          fi
          
          # V√©rification des modifications
          if git diff --cached --quiet; then
            echo "Aucun nouvel historique ou rapport d analyse"
          else
            # Statistiques
            HISTORIQUE_MODIFIE=$(git diff --cached --name-only | grep "historique_analyse/" | wc -l | tr -d ' ')
            RAPPORTS_MODIFIES=$(git diff --cached --name-only | grep "rapports_analyse/" | wc -l | tr -d ' ')
            
            # Message de commit
            MSG_COMMIT="üìù Mise √† jour des donn√©es d analyse [skip ci]"
            if [ "$HISTORIQUE_MODIFIE" -gt 0 ] && [ "$RAPPORTS_MODIFIES" -gt 0 ]; then
              MSG_COMMIT="üìù Mise √† jour de l historique et des rapports d analyse [skip ci]"
            elif [ "$RAPPORTS_MODIFIES" -gt 0 ]; then
              MSG_COMMIT="üìÑ Ajout de rapports d analyse [skip ci]"
            fi
            
            git commit -m "$MSG_COMMIT"
            
            # Synchronisation des modifications distantes pour √©viter les conflits de push concurrents
            git pull --rebase origin main || {
              echo "‚ö†Ô∏è Conflit de rebase, tentative avec la version locale"
              git rebase --abort
              git pull --rebase --strategy-option=ours origin main
            }
            
            git push
            echo "‚úÖ Soumis : $HISTORIQUE_MODIFIE fichier(s) d historique, $RAPPORTS_MODIFIES fichier(s) de rapport"
          fi
      
      - name: üîî Analyse des r√©sultats
        id: analyser_resultats
        if: always()
        run: |
          if [ -f rapports_analyse/*.txt ]; then
            PROBLEMES=$(grep "Nombre total de probl√®mes d√©tect√©s:" rapports_analyse/*.txt | grep -oE '[0-9]+' || echo "0")
            echo "$PROBLEMES probl√®me(s) potentiel(s) d√©tect√©(s)"
            echo "nombre_problemes=$PROBLEMES" >> $GITHUB_OUTPUT
            
            if [ "$PROBLEMES" -gt 0 ]; then
              echo "problemes_detectes=true" >> $GITHUB_OUTPUT
            else
              echo "problemes_detectes=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "nombre_problemes=0" >> $GITHUB_OUTPUT
            echo "problemes_detectes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: üì¢ Cr√©ation d Issue d alerte
        if: |
          always() && 
          github.event.inputs.creer_issue == 'true' && 
          steps.analyser_resultats.outputs.problemes_detectes == 'true'
        uses: actions/github-script@v7
        env:
          NOMBRE_PROBLEMES: ${{ steps.analyser_resultats.outputs.nombre_problemes }}
          TYPE_ANALYSE: ${{ github.event.inputs.type_analyse }}
          CIBLE_ANALYSE: ${{ github.event.inputs.cible }}
        with:
          script: |
            const fs = require('fs');
            const dossierRapport = 'rapports_analyse';
            const nombreProblemes = process.env.NOMBRE_PROBLEMES;
            const typeAnalyse = process.env.TYPE_ANALYSE;
            const cibleAnalyse = process.env.CIBLE_ANALYSE;
            
            if (fs.existsSync(dossierRapport)) {
              const fichiers = fs.readdirSync(dossierRapport);
              if (fichiers.length > 0) {
                const cheminRapport = `${dossierRapport}/${fichiers[0]}`;
                const contenu = fs.readFileSync(cheminRapport, 'utf8');
                const apercu = contenu.split('\n').slice(0, 120).join('\n');
                
                const titreIssue = `üö® [Analyse Manuelle] ${nombreProblemes} fuite(s) potentielle(s) de cl√©s d√©tect√©e(s)`;
                const corpsIssue = [
                  '# üîç Rapport d analyse manuelle',
                  '',
                  '## Informations d analyse',
                  '',
                  `- Type d analyse: ${typeAnalyse}`,
                  `- Cible d analyse: ${cibleAnalyse}`,
                  `- Heure d ex√©cution: ${new Date().toLocaleString('fr-FR')}`,
                  `- Nombre de probl√®mes d√©tect√©s: ${nombreProblemes}`,
                  `- Ex√©cution Workflow: [#${context.runNumber}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                  '',
                  '## üìÑ Aper√ßu du rapport',
                  '',
                  '```',
                  apercu,
                  '```',
                  '',
                  '## üîó Rapport complet',
                  '',
                  `T√©l√©chargez le rapport complet depuis [Artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}).`,
                  '',
                  '## ‚ö†Ô∏è Actions recommand√©es',
                  '',
                  '1. V√©rifier imm√©diatement les probl√®mes √† haute confiance signal√©s',
                  '2. Rotationner toutes les cl√©s API compromises',
                  '3. Utiliser des variables d environnement ou un service de gestion de secrets',
                  '4. Mettre √† jour .gitignore pour pr√©venir les futures fuites',
                  '',
                  '---',
                  '*Cette Issue a √©t√© cr√©√©e automatiquement par GitHub Actions*'
                ].join('\n');
                
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: titreIssue,
                  body: corpsIssue,
                  labels: ['securit√©', 'analyse-manuelle', 'a-reviser']
                });
              }
            }